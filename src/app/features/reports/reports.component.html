<div class="reports-list">
    <h2>Reports</h2>

    <!-- AI Summary Section -->
    <div class="ai-summary-section">
        <div class="section-header">
            <h3>AI Summaries</h3>
            <a mat-button color="primary" routerLink="/reports/summaries">
                <mat-icon>history</mat-icon> View All Summaries
            </a>
        </div>

        <div *ngIf="summaryLoading" style="text-align: center; padding: 24px;">
            <mat-spinner diameter="32"></mat-spinner>
        </div>

        <div class="summary-cards" *ngIf="!summaryLoading && (dailySummary || weeklySummary)">
            <mat-card *ngIf="dailySummary" class="summary-card clickable-card"
                [routerLink]="['/reports/summaries', dailySummary.id]">
                <mat-card-header>
                    <mat-card-title>Daily Summary</mat-card-title>
                    <mat-card-subtitle>
                        {{ dailySummary.period_start }}
                        <span class="method-badge" [class.ai]="dailySummary.generation_method === 'ai'"
                            [class.fallback]="dailySummary.generation_method === 'fallback'">
                            {{ dailySummary.generation_method === 'ai' ? 'AI' : 'Fallback' }}
                        </span>
                    </mat-card-subtitle>
                </mat-card-header>
                <mat-card-content>
                    <p class="summary-preview">{{ dailySummary.summary_text | slice:0:200 }}{{
                        dailySummary.summary_text.length > 200 ? '...' : '' }}</p>
                    <small class="generated-at">Generated: {{ dailySummary.generated_at | date:'medium' }}</small>
                </mat-card-content>
            </mat-card>

            <mat-card *ngIf="weeklySummary" class="summary-card clickable-card"
                [routerLink]="['/reports/summaries', weeklySummary.id]">
                <mat-card-header>
                    <mat-card-title>Weekly Summary</mat-card-title>
                    <mat-card-subtitle>
                        {{ weeklySummary.period_start }} â€” {{ weeklySummary.period_end }}
                        <span class="method-badge" [class.ai]="weeklySummary.generation_method === 'ai'"
                            [class.fallback]="weeklySummary.generation_method === 'fallback'">
                            {{ weeklySummary.generation_method === 'ai' ? 'AI' : 'Fallback' }}
                        </span>
                    </mat-card-subtitle>
                </mat-card-header>
                <mat-card-content>
                    <p class="summary-preview">{{ weeklySummary.summary_text | slice:0:200 }}{{
                        weeklySummary.summary_text.length > 200 ? '...' : '' }}</p>
                    <small class="generated-at">Generated: {{ weeklySummary.generated_at | date:'medium' }}</small>
                </mat-card-content>
            </mat-card>
        </div>

        <p *ngIf="!summaryLoading && !dailySummary && !weeklySummary" class="no-summaries">
            No scheduled summaries yet. Generate one on demand below, or wait for the next automatic daily/weekly run.
        </p>
    </div>

    <!-- On-demand AI Summary Generation -->
    <mat-card *ngIf="isManager" class="on-demand-card">
        <mat-card-header>
            <mat-card-title>Generate AI Summary</mat-card-title>
        </mat-card-header>
        <mat-card-content>
            <div class="filter-row">
                <mat-form-field appearance="outline">
                    <mat-label>Start Date</mat-label>
                    <input matInput [matDatepicker]="aiFromPicker" [(ngModel)]="aiDateFrom" />
                    <mat-datepicker-toggle matIconSuffix [for]="aiFromPicker"></mat-datepicker-toggle>
                    <mat-datepicker #aiFromPicker></mat-datepicker>
                </mat-form-field>
                <mat-form-field appearance="outline">
                    <mat-label>End Date</mat-label>
                    <input matInput [matDatepicker]="aiToPicker" [(ngModel)]="aiDateTo" />
                    <mat-datepicker-toggle matIconSuffix [for]="aiToPicker"></mat-datepicker-toggle>
                    <mat-datepicker #aiToPicker></mat-datepicker>
                </mat-form-field>
                <button mat-raised-button color="accent" (click)="generateAISummary()"
                    [disabled]="!aiDateFrom || !aiDateTo || generating">
                    <mat-icon>auto_awesome</mat-icon>
                    {{ generating ? 'Generating...' : 'Generate AI Summary' }}
                </button>
            </div>
        </mat-card-content>
    </mat-card>

    <!-- Existing Reports Section -->
    <mat-card class="filter-card">
        <mat-card-content>
            <div class="filter-row">
                <mat-form-field appearance="outline">
                    <mat-label>Date From</mat-label>
                    <input matInput [matDatepicker]="fromPicker" [(ngModel)]="dateFrom" />
                    <mat-datepicker-toggle matIconSuffix [for]="fromPicker"></mat-datepicker-toggle>
                    <mat-datepicker #fromPicker></mat-datepicker>
                </mat-form-field>
                <mat-form-field appearance="outline">
                    <mat-label>Date To</mat-label>
                    <input matInput [matDatepicker]="toPicker" [(ngModel)]="dateTo" />
                    <mat-datepicker-toggle matIconSuffix [for]="toPicker"></mat-datepicker-toggle>
                    <mat-datepicker #toPicker></mat-datepicker>
                </mat-form-field>
                <button mat-raised-button color="primary" (click)="loadReport()">Generate</button>
                <button mat-button *ngIf="isManager" (click)="exportPDF()"><mat-icon>picture_as_pdf</mat-icon>
                    PDF</button>
                <button mat-button *ngIf="isManager" (click)="exportExcel()"><mat-icon>table_chart</mat-icon>
                    Excel</button>
            </div>
        </mat-card-content>
    </mat-card>

    <div *ngIf="reportData" class="report-content">
        <div class="summary-grid">
            <mat-card><mat-card-content>
                    <div class="stat">{{ reportData.tasks.total }}</div>
                    <div>Total</div>
                </mat-card-content></mat-card>
            <mat-card><mat-card-content>
                    <div class="stat">{{ reportData.tasks.created_in_period }}</div>
                    <div>Created</div>
                </mat-card-content></mat-card>
            <mat-card><mat-card-content>
                    <div class="stat">{{ reportData.tasks.closed_in_period }}</div>
                    <div>Closed</div>
                </mat-card-content></mat-card>
            <mat-card><mat-card-content>
                    <div class="stat">{{ reportData.tasks.overdue }}</div>
                    <div>Overdue</div>
                </mat-card-content></mat-card>
        </div>
    </div>
</div>