<div class="task-list">
    <div class="task-list-header">
        <h2>All Orders</h2>
        <div class="header-actions">
            <div class="switch-buttons">
                <a mat-raised-button color="primary" class="switch-btn" routerLink="/tasks" *ngIf="isManager"
                    routerLinkActive="active">
                    List
                </a>
                <a mat-raised-button color="primary" class="switch-btn" routerLink="/kanban" *ngIf="isManager"
                    routerLinkActive="active">
                    Kanban
                </a>
            </div>


            <a mat-raised-button color="primary" class="btn" routerLink="new" *ngIf="canCreate">
                <mat-icon>add</mat-icon> New Task
            </a>
        </div>
    </div>


    <app-filter-panel (filtersChange)="onFiltersChange($event)"></app-filter-panel>
    <app-search-bar placeholder="Search tasks..." (search)="onSearch($event)"></app-search-bar>

    <table mat-table [dataSource]="tasks" class="full-width">

        <!--Checkbox Column-->
        <ng-container matColumnDef="select">
            <th mat-header-cell *matHeaderCellDef></th>
            <td mat-cell *matCellDef="let task">
                <mat-checkbox (click)="$event.stopPropagation()" (change)="selectHandler(task)"
                    [checked]="selection.isSelected(task)">
                </mat-checkbox>
            </td>
        </ng-container>


        <ng-container matColumnDef="title">
            <th mat-header-cell *matHeaderCellDef>Title</th>
            <td mat-cell *matCellDef="let task">
                <a [routerLink]="[task.id]">{{ task.title }}</a>
            </td>
        </ng-container>

        <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Status</th>
            <td mat-cell *matCellDef="let task">
                <mat-chip [class]="'status-' + task.status"
                    [matMenuTriggerFor]="getNextStatuses(task.status).length ? statusMenu : null"
                    [style.cursor]="getNextStatuses(task.status).length ? 'pointer' : 'default'">
                    {{ statusLabel(task.status) }}
                    <mat-icon *ngIf="getNextStatuses(task.status).length" iconPositionEnd
                        style="font-size:16px;width:16px;height:16px">arrow_drop_down</mat-icon>
                </mat-chip>
                <mat-menu #statusMenu="matMenu">
                    <button mat-menu-item *ngFor="let s of getNextStatuses(task.status)"
                        (click)="onChangeStatus(task, s)">
                        {{ statusLabel(s) }}
                    </button>
                </mat-menu>
            </td>
        </ng-container>

        <ng-container matColumnDef="priority">
            <th mat-header-cell *matHeaderCellDef>Priority</th>
            <td mat-cell *matCellDef="let task">
                <mat-chip [class]="'priority-' + task.priority">{{ task.priority |titlecase }}</mat-chip>
            </td>
        </ng-container>

        <ng-container matColumnDef="assignees">
            <th mat-header-cell *matHeaderCellDef>Assignees</th>
            <td mat-cell *matCellDef="let task">
                <span *ngFor="let a of task.assignees; let last = last">
                    {{ a.first_name }} {{ a.last_name }}<span *ngIf="!last">, </span>
                </span>
            </td>
        </ng-container>

        <ng-container matColumnDef="client">
            <th mat-header-cell *matHeaderCellDef>Client</th>
            <td mat-cell *matCellDef="let task">{{ task.client?.name || '-' }}</td>
        </ng-container>

        <ng-container matColumnDef="tags">
            <th mat-header-cell *matHeaderCellDef>Tags</th>
            <td mat-cell *matCellDef="let task">
                <mat-chip-set>
                    <mat-chip *ngFor="let t of task.tags" [style.border-color]="t.color"
                        [style.background-color]="'transparent'"
                        [style.color]="isLightColor(t.color) ? '#000' : t.color" class="tag-chip">
                        {{ t.name }}
                    </mat-chip>
                </mat-chip-set>
            </td>
        </ng-container>

        <ng-container matColumnDef="deadline">
            <th mat-header-cell *matHeaderCellDef>Deadline</th>
            <td mat-cell *matCellDef="let task" [class.deadline-overdue]="isOverdue(task)">
                <ng-container *ngIf="isOverdue(task); else normalDeadline">
                    {{ getOverdueDays(task) }} ({{ task.deadline | date:'dd.MM.yyyy HH:mm'  }})
                </ng-container>
                <ng-template #normalDeadline>{{ task.deadline | date:'dd.MM.yyyy HH:mm'  }}</ng-template>
            </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
    </table>

    <mat-paginator [length]="totalCount" [pageSize]="pageSize" [pageIndex]="currentPage - 1"
        (page)="onPageChange($event)">
    </mat-paginator>
</div>