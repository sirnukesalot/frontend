<div *ngIf="task">
    <div class="header">
        <h2>{{ task.title }}</h2>
        <div class="actions">
            <a mat-button [routerLink]="['/tasks', task.id, 'edit']" *ngIf="isManager">
                <mat-icon>edit</mat-icon> Edit
            </a>
        </div>
    </div>

    <div class="meta">
        <mat-chip [class]="'status-' + task.status">{{ task.status }}</mat-chip>
        <mat-chip [class]="'priority-' + task.priority">{{ task.priority }}</mat-chip>
        <span>Deadline: {{ task.deadline | date:'mediumDate' }}</span>
        <span *ngIf="task.client">Client: {{ task.client.name }}</span>
    </div>

    <mat-card class="description-card">
        <mat-card-content>
            <p>{{ task.description }}</p>
        </mat-card-content>
    </mat-card>

    <div class="info-grid">
        <div>
            <h4>Assignees</h4>
            <div *ngFor="let a of task.assignees">{{ a.first_name }} {{ a.last_name }}</div>
            <div *ngIf="!task.assignees.length">No assignees</div>
        </div>
        <div>
            <h4>Tags</h4>
            <mat-chip-set>
                <mat-chip *ngFor="let t of task.tags">{{ t.name }}</mat-chip>
            </mat-chip-set>
            <div *ngIf="!task.tags.length">No tags</div>
        </div>
        <div>
            <h4>Created by</h4>
            <span>{{ task.created_by?.first_name }} {{ task.created_by?.last_name }}</span>
            <br /><small>{{ task.created_at | date:'medium' }}</small>
        </div>
    </div>

    <mat-tab-group>
        <mat-tab label="Attachments ({{ task.attachments?.length || 0 }})">
            <mat-list>
                <mat-list-item *ngFor="let a of task.attachments">
                    <mat-icon matListItemIcon>attach_file</mat-icon>
                    <span matListItemTitle>{{ a.filename || a.original_filename }}</span>
                    <span matListItemLine>{{ a.file_size | number }} bytes</span>
                </mat-list-item>
            </mat-list>
        </mat-tab>
        <mat-tab label="History">
            <mat-list>
                <mat-list-item *ngFor="let h of task.history">
                    <span matListItemTitle>{{ h.action }}: {{ h.field_name || '' }}</span>
                    <span matListItemLine>{{ h.old_value }} -> {{ h.new_value }} ({{ h.timestamp | date:'medium'
                        }})</span>
                </mat-list-item>
            </mat-list>
        </mat-tab>
    </mat-tab-group>
</div>